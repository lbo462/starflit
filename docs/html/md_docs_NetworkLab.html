<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Starflit: Network Lab</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
</script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
</script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript">
    DoxygenAwesomeParagraphLink.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Starflit128.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Starflit
   </div>
   <div id="projectbrief">Arduino project that aims to organize a fleet of strandbeest-like robots.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_docs_NetworkLab.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Network Lab </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md9"></a>
Why?</h1>
<p>This lab was configured to be able to configure the RPis via SSH, without needing to connect them to a monitor.</p>
<p>To build this lab, you will need:</p>
<ul>
<li>a network switch</li>
<li>a RPi (which you will configure as a DHCP server and router).</li>
</ul>
<h1><a class="anchor" id="autotoc_md10"></a>
Instructions</h1>
<p>In order to configure a RPi as a router, you will first need to flash RaspbianOS on a microSD card. Instructions to do so can be found here <a href="InitializeRPis.md#format-the-micro-sd-card">InitializeRPis</a>.</p>
<p>In the <code>cmdline.txt</code> file in the boot partition, add the following line: <code>ip=192.168.1.254</code>.</p>
<p>Connect both your computer and the RPi to the switch. You should now be able to connect to it via SSH with the aforementioned IP.</p>
<blockquote class="doxtable">
<p>Once connected, don't forget to <code>sudo apt-get update &amp;&amp; sudo apt-get upgrade</code>. </p>
</blockquote>
<p>For the connection to the internet, we will be connecting to the Eduroam network via Wifi. It is a WPA2 network configured with PEAP / MSCHAPv2 authentication (this is import because this creates many complications...).</p>
<h2><a class="anchor" id="autotoc_md11"></a>
WPA configuration</h2>
<ol type="1">
<li>Edit the <code>/etc/wpa_supplicant/wpa_supplicant.conf</code> file.</li>
<li>Insert the following configuration:</li>
</ol>
<div class="fragment"><div class="line">ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev                                               update_config=1</div>
<div class="line">ap_scan=1</div>
<div class="line">network={</div>
<div class="line">ssid=&quot;eduroam&quot;</div>
<div class="line">scan_ssid=1</div>
<div class="line">key_mgmt=WPA-EAP</div>
<div class="line">eap=PEAP</div>
<div class="line">identity=&quot;${EDUROAM_EMAIL}&quot;</div>
<div class="line">phase2=&quot;auth=MSCHAPV2&quot;</div>
<div class="line">password=&quot;${EDUROAM_PW}&quot;</div>
<div class="line">anonymous_identity=&quot;anonymous@insa-lyon.fr&quot;</div>
<div class="line">}  </div>
</div><!-- fragment --><blockquote class="doxtable">
<p>For the identity and password, you can use your own university email address and password. </p>
</blockquote>
<p>It is a good security measure to use environment variables in configuration files when it comes to usernames and passwords so that they don't appear in cleartext on github ðŸ˜„.</p>
<p>You can configure environment variables like so:</p>
<div class="fragment"><div class="line">export MYVAR=&#39;myPassword&#39;</div>
</div><!-- fragment --><p>If you want it to be permanent:</p>
<div class="fragment"><div class="line">#TODO</div>
</div><!-- fragment --><p>The RPi (router) should now be able to connect to Eduroam. You can test it by running the following command:</p>
<div class="fragment"><div class="line">sudo /sbin/wpa_supplicant -i wlan0 -c /etc/wpa_supplicant/wpa_supplicant.conf</div>
</div><!-- fragment --><p>You can make sure the router is connected with this command <code>wpa_cli status</code>.</p>
<h2><a class="anchor" id="autotoc_md12"></a>
DHCP configuration</h2>
<p>The router will act as a DHCP server that will distribute IPs to the RPis so that we can easily connect to them via SSH.</p>
<p>The steps are simple:</p>
<ol type="1">
<li>Download the DHCP server <code>sudo apt install isc-dhcp-server</code>.</li>
<li>Edit <code>/etc/dhcp/dhcpd.conf</code> and add the following:</li>
</ol>
<div class="fragment"><div class="line">default-lease-time 3600;</div>
<div class="line">max-lease-time 7200;</div>
<div class="line"> </div>
<div class="line">subnet 192.168.1.0 netmask 255.255.255.0 {</div>
<div class="line">    option-routers 192.168.1.254;</div>
<div class="line">    option domain-name-servers 8.8.8.8;</div>
<div class="line">    range 192.168.1.10 192.168.1.30;</div>
<div class="line">}</div>
</div><!-- fragment --><ol type="1">
<li>Set the interface you want your DHCP server to be configured on in <code>/etc/default/isc-dhcp-server</code> by appending <code>eth0</code> in <code>INTERFACESv4=""</code>.</li>
<li>Restart the service:</li>
</ol>
<div class="fragment"><div class="line">sudo systemctl restart isc-dhcp-server.service</div>
</div><!-- fragment --><p>You can check the leases that are distributed to your clients via the following command:</p>
<div class="fragment"><div class="line">dhcp-lease-list</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md13"></a>
Routing configuration</h2>
<h3><a class="anchor" id="autotoc_md14"></a>
IP forwarding</h3>
<p>Activate IP forwarding by editing the <code>/etc/sysctl.conf</code> file and uncommenting <code>net.ipv4.ip_forward=1</code>.</p>
<h3><a class="anchor" id="autotoc_md15"></a>
NAT</h3>
<p>Activate NAT Masquerade with <code>iptables</code>:</p>
<ul>
<li><code>sudo apt install iptables</code></li>
<li><code>sudo iptables -t nat -A POSTROUTING -o wlan0 -j MASQUERADE</code></li>
<li><code>sudo apt install iptables-persistent</code> to render the configuration persistent on reboot.</li>
</ul>
<p>You can check your configuration with <code>sudo iptables -t nat -L</code>.</p>
<h3><a class="anchor" id="autotoc_md16"></a>
Default route</h3>
<p>Delete the current default route:</p>
<div class="fragment"><div class="line">sudo ip r d default</div>
</div><!-- fragment --><p>Add a new one to the Eduroam gateway:</p>
<div class="fragment"><div class="line">sudo ip r a default via 10.56.0.1 dev wlan0</div>
</div><!-- fragment --><p>Your packets should now be routed correctly ðŸ“¦.</p>
<h2><a class="anchor" id="autotoc_md17"></a>
Run everything on startup</h2>
<p>We don't want to manually connect the router to the Wifi and configure the default routes everytime we turn the router on. To solve this problem, we are going to create a service that will run on startup, as well as a script to configure the default route.</p>
<div class="fragment"><div class="line">[Unit]</div>
<div class="line">Description=WPA supplicant</div>
<div class="line">Wants=network.target</div>
<div class="line">After=network.target</div>
<div class="line">[Service]</div>
<div class="line">Type=simple</div>
<div class="line">ExecStartPre=/sbin/ip link set wlan0 up</div>
<div class="line">ExecStart=/home/router/setup_wpa.sh</div>
<div class="line">RemainAfterExit=yes</div>
<div class="line">[Install]</div>
<div class="line">WantedBy=multi-user.target</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
